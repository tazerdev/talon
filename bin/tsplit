#!/usr/bin/env python3

import os
import csv
import sys
import ephem
import json
import guano
import struct
import signal
import argparse
from zoneinfo import ZoneInfo
from datetime import datetime as dt
from datetime import timedelta
import talonlib

def signal_handler(signum, frame):
    signal.signal(signum, signal.SIG_IGN)
    sys.exit(0)

def ParseCommandLineArguments():
    arg_parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter, description="tsplit is a utility for extracting one channel from a WAV file.")
    arg_parser.add_argument('-i', '--input', type=str, required=True, help="Path to the wave file to split.")
    arg_parser.add_argument('-c', '--channel', type=int, default=0, help="In stereo files, left is 0, right is 1.")
    arg_parser.add_argument('-d', '--debug', action='store_true', help='Print extra debugging information.')
    arg_parser.add_argument('-q', '--quiet', action='store_true', help="Don't display progress indicator.")
    arg_parser.add_argument('-m', '--metadata', action='store_true', help="Display WAV metadata only then exit.")

    return arg_parser

def main():
    arg_parser = ParseCommandLineArguments()
    args = arg_parser.parse_args()

    signal.signal(signal.SIGINT, signal_handler)

    if os.path.exists(args.input):
        twf = talonlib.TalonWAVFile(args.input, section=None, taxonomy=None, clear=False, debug=args.debug)
        
        if args.debug or args.metadata:
            print(twf)

        if not args.metadata:
            if twf.channels > args.channel:
                twf.ExtractChannel(args.channel, args.quiet)
            else:
                print(f"Specified channel exceeds number of channels in WAV file.")
    else:
        print(f"Input file does not exist.")

if __name__ == "__main__":
    main()
